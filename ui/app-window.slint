import { ComboBox, SpinBox, Button, CheckBox, Slider, LineEdit, ScrollView, ListView, HorizontalBox, VerticalBox, GridBox, StandardButton, Palette } from "std-widgets.slint";
import { Recipe } from "recipe.slint";

@rust-attr(derive(serde::Serialize, serde::Deserialize))
export struct FileItem  {
    title: string,
    checked: bool,
    is-dir: bool,

    full_path: string,
}

export struct Point  {
    x: int,
    y: int,
}

export component AppWindow inherits Window {
    // Current directory in the adress bar
    in-out property <string> path: "/home/jord/coding/texturizers";

    // Placeholder image to display the logo until the user selects his own image
    private property <string> logo-path: "TexturizersLogo.png";
    in-out property <image> image: @image-url("TexturizersLogo.png");
    in-out property <string> image-path: "TexturizersLogo.png";

    // Mouse
    in-out property <Point> image-initial-click: { x: 0, y: 0 };
    in-out property <Point> image-release-click: { x: 0, y: 0 };

    public pure function config() -> [bool] {
        return [
            x16.checked,
            x32.checked,
            x64.checked,
            x128.checked,
            x256.checked,
            x512.checked,
            w.checked,
            h.checked
        ];
    }

    // User clicked the back / go up button to change directory
    callback go-to-parent() -> string;

    // Must be called when directory changed to display the new files
    callback update-file-tree();

    // Updates the displayed image as well as the Boxed / cached image
    callback setimg(path: string);

    // save an image to the out-dir
    callback export(nearest: bool, output-dir: string, name: string, config: [bool]);

    //Image manipulation
    in-out property <bool> nearest: false;
    in-out property <string> output-dir: root.path;
    in-out property <bool> everything-in-dir: false;

    callback roll-y(y: float);
    callback roll-x(x: float);

    in property original-image <=> original.source;

    in-out property <[FileItem]> file-tree-model: [];
    title: "Texturize.rs";
    in-out property <int> active-tab;
    VerticalLayout {

        tab_bar := HorizontalLayout {
            spacing: 3px;
            Button {
                text: "Texture";
                clicked => {
                    root.active-tab = 0;
                }
            }

            Button {
                text: "Settings";
                clicked => {
                    root.active-tab = 1;
                }
            }
        }

        Rectangle {
            clip: true;
            Rectangle {
                x: root.active-tab == 0 ? 0 : root.active-tab < 0 ? - self.width - 1px : parent.width + 1px;
                animate x {
                    duration: 125ms;
                    easing: ease;
                }
                VerticalBox {

                    HorizontalLayout {
                        height: 30px;
                        Button {
                            private property <string> parent;
                            parent: "";
                            text: "ðŸ „";
                            clicked => {
                    // side-effects:
                    // 1. Updates the root.path to the parent
                    // 2. Refreshes the filetree
                    self.parent = go-to-parent();
                                le.text = root.path;
                            }
                        }

                        le := LineEdit {
                            text: root.path;

                            init() => {
                                self.focus();
                                // side-effects:
                                // 1. Refreshes the filetree
                                root.update-file-tree();
                            }

                            edited(new) => {
                                root.path = "\{new}";
                                // side-effects:
                                // 1. Refreshes the filetree
                                root.update-file-tree();
                            }
                        }
                    }

                    HorizontalLayout {
                        ListView {
                            for file in root.file-tree-model: HorizontalLayout {
                                padding-bottom: 3px;
                                Button {
                                    private property <bool> was-clicked;
                                    in-out property <bool> is-dir;
                                    was-clicked: false;
                                    height: 30px;
                                    width: parent.width;
                                    text: file.title;

                                    checked: file.checked;
                                    is-dir: file.is-dir;
                                    primary: self.is-dir;

                                    clicked() => {
                                        if (self.was-clicked && self.is-dir) {
                                            root.path = file.full-path;
                                            le.text = file.full-path;
                                // side-effects:
                                // 1. Refreshes the filetree
                                root.update-file-tree();
                                        }
                                        root.setimg(file.full-path);
                                        self.was-clicked = true;
                                    }
                                }
                            }
                        }

                        VerticalBox {
                            HorizontalBox {
                                x := Slider {
                                    private property <float> cur-x;
                                    cur-x: 0.0;
                                    value: 0.0;
                                    minimum: 0.0;
                                    maximum: 1.0;
                                    step: 0.05;

                                    changed(value) => {
                                        if (value - self.cur-x != 0) {
                                            roll-x(value - self.cur-x);
                                        }
                                        self.cur-x = value;
                                    }
                                }

                                y := Slider {
                                    private property <float> cur-y;
                                    cur-y: 0.0;
                                    value: 0.0;
                                    minimum: 0.0;
                                    maximum: 1.0;
                                    step: 0.05;

                                    changed(value) => {
                                        if (value - self.cur-y != 0) {
                                            roll-y(value - self.cur-y);
                                        }
                                        self.cur-y = value;
                                    }
                                }
                            }

                            HorizontalBox {
                                height: 30px;
                                nearest := CheckBox {
                                    height: parent.height;
                                    text: "Nearest";
                                    checked: false;
                                    toggled() => {
                                        root.nearest = !root.nearest;
                                    }
                                }

                                all-in-dir := CheckBox {
                                    height: parent.height;
                                    text: "Everything in dir";
                                    checked: false;
                                    toggled() => {
                                        root.everything-in-dir = !root.everything-in-dir;
                                    }
                                }

                                Button {
                                    height: parent.height;
                                    text: "Export";

                                    clicked => {
                                        export(root.nearest, root.output-dir, root.image-path, root.config());
                                    }
                                }
                            }

                            HorizontalBox {
                                min-width: 1000px;
                                max-width: 1200px;
                                min-height: 1000px;

                                original := Image {
                                    image-fit: fill;
                                    source: root.image;
                                }
                            }
                        }
                    }
                }
            }

            Rectangle {
                padding-left: 20px;
                x: root.active-tab == 1 ? 0 : root.active-tab < 1 ? - self.width - 1px : parent.width + 1px;
                animate x {
                    duration: 125ms;
                    easing: ease;
                }

                VerticalLayout {
                    height: 500px;

                    Text {
                        text: "Output dir: ";
                        height: 20px;
                    }

                    LineEdit {
                        text: root.path;
                        height: 30px;

                        edited(text) => {
                            root.output-dir = text;
                        }
                    }

                    h := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "Scale by height";
                        checked: true;
                    }

                    w := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "Scale by width";
                        checked: true;
                    }

                    x16 := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "x16";
                        checked: true;
                    }

                    x32 := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "x32";
                        checked: true;
                    }

                    x64 := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "x64";
                        checked: true;
                    }

                    x128 := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "x128";
                        checked: true;
                    }

                    x256 := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "x256";
                        checked: true;
                    }

                    x512 := CheckBox {
                        padding-left: 20px;
                        height: 30px;
                        width: parent.width;
                        text: "x512";
                        checked: true;
                    }
                }
            }
        }
    }
}
